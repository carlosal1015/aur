name: Test Rust bindings for preCICE stable

on:
  push:
    branches: [main]
    paths:
      - docker/actions.Dockerfile
  schedule:
    - cron: "0 2 * * 5"

jobs:
  test_bindings:
    runs-on: ubuntu-22.04
    container: ghcr.io/carlosal1015/aur/actions:latest
    env:
      PACKAGES: "cargo"
      GPG_KEY: "2403871B121BD8BB"
      VERSION: "3.0.1"
    steps:
      - name: Install Rust bindings for preCICE
        run: |
          pacman --needed --noconfirm --noprogressbar -Syuq ${PACKAGES} >/dev/null 2>&1
          pacman -Qi ${PACKAGES}
          cargo init
          cargo add precice@${VERSION::3}
          cargo build --release --all-targets

      - name: Run Rust bindings's tests for preCICE
        run: |
          pushd ~/.cargo/registry/src/index.crates.io-*/precice-${VERSION}
          cargo run --release --example=solverdummy -- examples/precice-config.xml SolverOne &
          cargo run --release --example=solverdummy -- examples/precice-config.xml SolverTwo
          popd
